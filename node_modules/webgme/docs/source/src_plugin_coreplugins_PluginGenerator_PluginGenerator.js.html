<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/plugin/coreplugins/PluginGenerator/PluginGenerator.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/plugin/coreplugins/PluginGenerator/PluginGenerator.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*globals define*/
/*jshint node:true, browser:true*/
/**
 * Plugin for generating other plugins.
 *
 * @author pmeijer / https://github.com/pmeijer
 * @author lattmann / https://github.com/lattmann
 * @module CorePlugins:PluginGenerator
 */

define([
    'plugin/PluginConfig',
    'plugin/PluginBase',
    'text!./metadata.json',
    'common/util/ejs',
    'plugin/PluginGenerator/PluginGenerator/Templates/Templates'
], function (PluginConfig, PluginBase, pluginMetadata, ejs, TEMPLATES) {
    'use strict';

    pluginMetadata = JSON.parse(pluginMetadata);

    function PluginGenerator() {
        // Call base class's constructor
        PluginBase.call(this);

        this.pluginMetadata = pluginMetadata;

        this.currentConfig = null;
        this.pluginDir = '';
        this.testDir = '';
        this.filesToAdd = {};
    }

    PluginGenerator.metadata = pluginMetadata;

    // Prototypical inheritance from PluginBase.
    PluginGenerator.prototype = Object.create(PluginBase.prototype);
    PluginGenerator.prototype.constructor = PluginGenerator;

    PluginGenerator.prototype.main = function (callback) {
        var self = this,
            pluginFileContent,
            pluginFileName,
            metadataFileContent,
            dirCommon,
            i,
            nbrOfFiles,
            fileKeys,
            error = '',
            artifact;

        // Get and log the configuration which will be appended to and used in the templates.
        self.currentConfig = self.getCurrentConfig();
        self.logger.info('Current configuration');
        self.logger.info(JSON.stringify(self.currentConfig, null, 4));

        // Update date, projectName and paths
        self.currentConfig.date = new Date();
        self.currentConfig.projectName = self.projectName;
        self.currentConfig.version = self.getVersion();
        dirCommon = '/plugins/' + self.projectName + '/' + self.currentConfig.pluginID + '/';
        self.pluginDir = 'src' + dirCommon;
        self.testDir = 'test' + dirCommon;

        // Add test file if requested.
        if (self.currentConfig.test) {
            self.filesToAdd[self.testDir + self.currentConfig.pluginID + '.spec.js'] =
                ejs.render(TEMPLATES['unit_test.js.ejs'], self.currentConfig);
        }
        self.addTemplateFile();
        if (self.currentConfig.meta) {
            self.addMetaFile();
        }
        // Add the plugin file.
        pluginFileContent = ejs.render(TEMPLATES['plugin.js.ejs'], self.currentConfig);
        pluginFileName = self.pluginDir + self.currentConfig.pluginID + '.js';
        self.filesToAdd[pluginFileName] = pluginFileContent;
        // Add the metadata.json
        metadataFileContent = ejs.render(TEMPLATES['metadata.json.ejs'], self.currentConfig);
        self.filesToAdd[self.pluginDir + 'metadata.json'] = metadataFileContent;

        // Add the file at the end.
        self.logger.info(JSON.stringify(self.filesToAdd, null, 4));
        fileKeys = Object.keys(self.filesToAdd);
        nbrOfFiles = fileKeys.length;
        artifact = self.blobClient.createArtifact('pluginFiles');

        function addFileByFile(fileKey, fileToAdd) {
            artifact.addFile(fileKey, fileToAdd, function (err, hash) {
                error = err ? error + err : error;
                nbrOfFiles -= 1;
                self.logger.debug(fileKey, hash);
                if (nbrOfFiles === 0) {
                    if (error) {
                        callback('Something went wrong when adding files: ' + error, self.result);
                        return;
                    }
                    self.blobClient.saveAllArtifacts(function (err, hashes) {
                        if (err) {
                            callback(err, self.result);
                            return;
                        }
                        self.result.addArtifact(hashes[0]);
                        self.createMessage(null, 'Extract the pluginFiles.zip in your repository.');
                        self.createMessage(null, 'Append "' + './src/plugins/' + self.projectName +
                        '" to "pluginBasePaths" in config.js.');
                        self.createMessage(self.rootNode, 'Select the root-node and add ' +
                        self.currentConfig.pluginID + ' to the validPlugins under the META tab (separate with spaces).');
                        if (self.currentConfig.test) {
                            self.createMessage(null, 'For the necessary test setup and more examples of how ' +
                            'to write tests see https://github.com/webgme/webgme-boilerplate.');
                        }
                        self.logger.info('Artifacts are saved here: ' + hashes.toString());

                        self.result.setSuccess(true);
                        callback(null, self.result);
                    });
                }
            });
        }

        for (i = 0; i &lt; fileKeys.length; i += 1) {
            addFileByFile(fileKeys[i], self.filesToAdd[fileKeys[i]]);
        }
    };

    PluginGenerator.prototype.addMetaFile = function () {
        var self = this,
            i,
            metaNodes = [],
            names = Object.keys(self.META),
            nodeData,
            nodeDataType = {
                name: null,
                path: null
            },
            compare = function (a, b) {
                return a.name.localeCompare(b.name);
            };
        // Get all the names and paths for the meta nodes.
        for (i = 0; i &lt; names.length; i += 1) {
            nodeData = Object.create(nodeDataType);
            nodeData.name = names[i];
            nodeData.path = self.core.getPath(self.META[names[i]]);
            metaNodes.push(nodeData);
        }
        // When done sort them by names.
        metaNodes.sort(compare);
        self.filesToAdd[self.pluginDir + 'meta.js'] = ejs.render(TEMPLATES['meta.js.ejs'], {
            metaNodes: metaNodes,
            date: self.currentConfig.date,
            version: self.currentConfig.version
        });
    };

    PluginGenerator.prototype.addTemplateFile = function () {
        var self = this,
            fileName,
            fileContent;

        if (self.currentConfig.templateType === 'Python') {
            self.currentConfig.templateExt = 'py';
            fileName = self.pluginDir + 'Templates/Python.py.ejs';
            fileContent = 'print "&lt;%=a%> and &lt;%=b%> provided."';
        } else if (self.currentConfig.templateType === 'CSharp') {
            self.currentConfig.templateExt = 'cs';
            fileName = self.pluginDir + 'Templates/CSharp.cs.ejs';
            fileContent = 'using System;\nnamespace Hey {\n\tclass Hi {\n\t\tstatic void Main()' +
            ' {\n\t\t\tConsole.WriteLine("&lt;%=a%> and &lt;%=b%> provided.");\n\t\t}\n\t}\n}';
        } else if (self.currentConfig.templateType === 'JavaScript') {
            self.currentConfig.templateExt = 'js';
            fileName = self.pluginDir + 'Templates/JavaScript.js.ejs';
            fileContent = 'console.info("&lt;%=a%> and &lt;%=b%> provided.);"';
        } else {
            self.currentConfig.templateType = null;
        }

        if (self.currentConfig.templateType) {
            self.filesToAdd[fileName] = fileContent;
            self.filesToAdd[self.pluginDir + 'Templates/combine_templates.js'] =
                ejs.render(TEMPLATES['combine_templates.js.ejs'], self.currentConfig);
        }
    };

    return PluginGenerator;
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="Bin_Apply.html">Bin:Apply</a></li><li><a href="Bin_Diff.html">Bin:Diff</a></li><li><a href="Bin_Export.html">Bin:Export</a></li><li><a href="Bin_Import.html">Bin:Import</a></li><li><a href="Bin_Merge.html">Bin:Merge</a></li><li><a href="Bin_ReassignRelids.html">Bin:ReassignRelids</a></li><li><a href="Bin_RunPlugin.html">Bin:RunPlugin</a></li><li><a href="Bin_StartServer.html">Bin:StartServer</a></li><li><a href="Bin_UserManager.html">Bin:UserManager</a></li><li><a href="CoreAddOns_ConstraintAddOn.html">CoreAddOns:ConstraintAddOn</a></li><li><a href="CoreAddOns_NotificationAddOn.html">CoreAddOns:NotificationAddOn</a></li><li><a href="CoreAddOns_TestAddOn.html">CoreAddOns:TestAddOn</a></li><li><a href="CorePlugins_AddOnGenerator.html">CorePlugins:AddOnGenerator</a></li><li><a href="CorePlugins_ConfigurationArtifact.html">CorePlugins:ConfigurationArtifact</a></li><li><a href="CorePlugins_ConstraintEvaluator.html">CorePlugins:ConstraintEvaluator</a></li><li><a href="CorePlugins_DecoratorGenerator.html">CorePlugins:DecoratorGenerator</a></li><li><a href="CorePlugins_ExecutorPlugin.html">CorePlugins:ExecutorPlugin</a></li><li><a href="CorePlugins_ImportV1.html">CorePlugins:ImportV1</a></li><li><a href="CorePlugins_LayoutGenerator.html">CorePlugins:LayoutGenerator</a></li><li><a href="CorePlugins_MergeExample.html">CorePlugins:MergeExample</a></li><li><a href="CorePlugins_MetaGMEParadigmImporter.html">CorePlugins:MetaGMEParadigmImporter</a></li><li><a href="CorePlugins_MinimalWorkingExample.html">CorePlugins:MinimalWorkingExample</a></li><li><a href="CorePlugins_PluginGenerator.html">CorePlugins:PluginGenerator</a></li><li><a href="CorePlugins_VisualizerGenerator.html">CorePlugins:VisualizerGenerator</a></li><li><a href="Executor_AddLabelJob.html">Executor:AddLabelJob</a></li><li><a href="Executor_NodeWorker.html">Executor:NodeWorker</a></li><li><a href="module-Core.html">Core</a></li><li><a href="module-EnsureDir.html">EnsureDir</a></li><li><a href="module-Storage.html">Storage</a></li><li><a href="Server.module_ConnectedWorker.html">ConnectedWorker</a></li><li><a href="Server.module_SimpleWorker.html">SimpleWorker</a></li><li><a href="Server_API.html">Server:API</a></li><li><a href="Server_GMEAuth.html">Server:GMEAuth</a></li><li><a href="Server_Logger.html">Server:Logger</a></li><li><a href="Server_SafeStorage.html">Server:SafeStorage</a></li><li><a href="Server_ServerWorkerManager.html">Server:ServerWorkerManager</a></li><li><a href="Server_StandAlone.html">Server:StandAlone</a></li><li><a href="Server_Storage.html">Server:Storage</a></li><li><a href="Server_Storage_Dynamo.html">Server:Storage:Dynamo</a></li><li><a href="Server_Storage_Memory.html">Server:Storage:Memory</a></li><li><a href="Server_Storage_Mongo.html">Server:Storage:Mongo</a></li><li><a href="Server_Storage_Neo4j.html">Server:Storage:Neo4j</a></li><li><a href="Server_Storage_Redis.html">Server:Storage:Redis</a></li><li><a href="Server_UserProject.html">Server:UserProject</a></li><li><a href="Server_WebSockets.html">Server:WebSockets</a></li><li><a href="Server_WorkerConstants.html">Server:WorkerConstants</a></li></ul><h3>Externals</h3><ul><li><a href="external-Promise.html">Promise</a></li></ul><h3>Classes</h3><ul><li><a href="AddOnBase.html">AddOnBase</a></li><li><a href="AddOnUpdateResult.html">AddOnUpdateResult</a></li><li><a href="Artifact.html">Artifact</a></li><li><a href="AuthorizerBase.html">AuthorizerBase</a></li><li><a href="BlobClient.html">BlobClient</a></li><li><a href="BlobMetadata.html">BlobMetadata</a></li><li><a href="BlobRunPluginClient.html">BlobRunPluginClient</a></li><li><a href="Core.html">Core</a></li><li><a href="ExecutorClient.html">ExecutorClient</a></li><li><a href="JobInfo.html">JobInfo</a></li><li><a href="OutputInfo.html">OutputInfo</a></li><li><a href="PluginBase.html">PluginBase</a></li><li><a href="PluginConfig.html">PluginConfig</a></li><li><a href="PluginHandler.html">PluginHandler</a></li><li><a href="PluginMessage.html">PluginMessage</a></li><li><a href="PluginNodeDescription.html">PluginNodeDescription</a></li><li><a href="PluginResult.html">PluginResult</a></li><li><a href="Project.html">Project</a></li><li><a href="ProjectInterface.html">ProjectInterface</a></li><li><a href="Server_GMEAuth-GMEAuth.html">GMEAuth</a></li><li><a href="Server_SafeStorage-SafeStorage.html">SafeStorage</a></li><li><a href="Server_Storage_Memory-Memory.html">Memory</a></li><li><a href="Server_UserProject-UserProject.html">UserProject</a></li><li><a href="WorkerRequests.html">WorkerRequests</a></li></ul><h3>Global</h3><ul><li><a href="global.html#cleanUp">cleanUp</a></li><li><a href="global.html#getProjectJson">getProjectJson</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#insertProjectJson">insertProjectJson</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#stop">stop</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Nov 28 2016 13:13:32 GMT-0600 (Central Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
