<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/server/middleware/executor/worker/node_worker.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/server/middleware/executor/worker/node_worker.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*globals define*/
/*jshint node:true*/
/**
 * @module Executor:NodeWorker
 * @author lattmann / https://github.com/lattmann
 * @author ksmyth / https://github.com/ksmyth
 */

var nodeRequire = require,
    log = function () {
        'use strict';
        var args = Array.prototype.slice.call(arguments);
        args.splice(0, 0, new Date().toISOString());
        console.log.apply(console, args);
    },
    err = function () {
        'use strict';
        var args = Array.prototype.slice.call(arguments);
        args.splice(0, 0, new Date().toISOString());
        console.error.apply(console, args);
    },
    logger = {
        debug: log,
        log: log,
        info: log,
        warn: log,
        error: err
    };

if (typeof define !== 'undefined') {

    define('node_worker', [
        'common/eventDispatcher',
        'blob/BlobClient',
        'executor/ExecutorWorker',
        'executor/JobInfo',
        'executor/ExecutorWorkerController',
        'url'
    ], function (eventDispatcher, BlobClient, ExecutorWorker, JobInfo, ExecutorWorkerController, url) {
        'use strict';

        return function (webGMEUrl, tempPath, parameters, availableProcessesContainer) {
            var worker,
                webGMEPort = url.parse(webGMEUrl).port || (url.parse(webGMEUrl).protocol === 'https:' ? 443 : 80);


            worker = new ExecutorWorker({
                server: url.parse(webGMEUrl).hostname,
                serverPort: webGMEPort,
                httpsecure: url.parse(webGMEUrl).protocol === 'https:',
                webgmeToken: undefined,
                availableProcessesContainer: availableProcessesContainer,
                workingDirectory: tempPath,
                executorNonce: parameters.executorNonce,
                logger: logger
            });

            log('Connecting to ' + webGMEUrl);

            var callback;
            worker.queryWorkerAPI(function (err, response) {
                if (!err) {
                    log('Connected to ' + webGMEUrl);
                }
                var refreshPeriod = 60 * 1000,
                    disconnected = false;
                callback = callback || function (err, response) {
                    if (err) {
                        log('Error connecting to ' + webGMEUrl + ' ' + err);
                        disconnected = true;
                    } else if (disconnected) {
                        log('Reconnected to ' + webGMEUrl);
                        disconnected = false;
                    }

                    if (response &amp;&amp; response.refreshPeriod) {
                        refreshPeriod = response.refreshPeriod;
                    }
                    /*var timeoutID = */
                    setTimeout(function () {
                        worker.queryWorkerAPI(callback);
                    }, refreshPeriod);
                };
                callback(err, response);
            });
            var cancel = function () {
                callback = function () {
                };
            };
            return cancel;
        };
    });
}

if (nodeRequire.main === module) {
    var fs = nodeRequire('fs'),
        path = nodeRequire('path'),
        superagent = nodeRequire('superagent'),
        configFileName = 'config.json',
        workingDirectory = 'executor-temp',
        cas;
    //https = nodeRequire('https'); FIXME take into use or remove it

    if (process.env.LATEST_CERTS) {
        cas = nodeRequire('ssl-root-cas/latest');
    } else {
        cas = nodeRequire('ssl-root-cas');
    }

    // This is used for tests
    if (process.argv.length > 2) {
        configFileName = process.argv[2];
        if (process.argv.length > 3) {
            workingDirectory = process.argv[3];
        }
    }

    cas.inject();
    fs.readdirSync(__dirname).forEach(function (file) {
        'use strict';
        var filename = path.resolve(__dirname, file);
        if ((filename.indexOf('.pem') === filename.length - 4) || (filename.indexOf('.crt') === filename.length - 4)) {
            log('Adding ' + file + ' to trusted CAs');
            cas.addFile(filename);
        }
    });

    superagent.Request.prototype._ca = (require('https').globalAgent.options.ca);
    var requirejs = require('./node_worker.classes.build.js').requirejs;

    [
        'superagent',
        'fs',
        'util',
        'events',
        'path',
        'child_process',
        'minimatch',
        'rimraf',
        'url',
        'q'
    ].forEach(function (name) {
            'use strict';
            requirejs.s.contexts._.defined[name] = nodeRequire(name);
        });

    global.WebGMEGlobal = {
        getConfig: function () {
            'use strict';
            return {};
        }
    }; // server: config.server, serverPort: config.port, httpsecure: config.protocol==='https' }; } };

    var webGMEUrls = Object.create(null),
        maxConcurrentJobs = 1,
        availableProcessesContainer = { //FIXME check why the definition cannot be moved to global namespace
            availableProcesses: maxConcurrentJobs
        }; // shared among all ExecutorWorkers

    requirejs(['node_worker'], function (addWebGMEConnection) {
        'use strict';
        var fs = nodeRequire('fs'),
            path = nodeRequire('path');

        function readConfig() {
            var config = {
                'http://127.0.0.1:8888': {}
            };
            try {
                var configJSON = fs.readFileSync(configFileName, {
                    encoding: 'utf8'
                });
                config = JSON.parse(configJSON);
                if (Array.isArray(config)) {
                    var oldConfig = config;
                    config = {};
                    oldConfig.forEach(function (webGMEUrl) {
                        config[webGMEUrl] = {};
                    });
                } else if (typeof (config) === 'string') {
                    config = {
                        config: {}
                    };
                } else {
                }
            } catch (e) {
                if (e.code !== 'ENOENT') {
                    throw e;
                }
            }
            Object.getOwnPropertyNames(config).forEach(function (key) {
                var webGMEUrl;
                if (key.indexOf('http') === 0) {
                    webGMEUrl = key;
                    if (Object.prototype.hasOwnProperty.call(webGMEUrls, webGMEUrl)) {
                    } else {
                        webGMEUrls[webGMEUrl] = addWebGMEConnection(webGMEUrl,
                            path.join(workingDirectory, '' + workingDirectoryCount++),
                            config[webGMEUrl], availableProcessesContainer);
                    }
                } else if (key === 'maxConcurrentJobs') {
                    availableProcessesContainer.availableProcesses += config.maxConcurrentJobs - maxConcurrentJobs;
                    maxConcurrentJobs = config.maxConcurrentJobs;
                } else {
                    log('Unknown configuration key ' + key);
                }
            });
            // remove webGMEUrls no longer in config
            Object.getOwnPropertyNames(webGMEUrls).forEach(function (webGMEUrl) {
                if (Object.prototype.hasOwnProperty.call(config, webGMEUrl) === false) {
                    log('Removing ' + webGMEUrl);
                    webGMEUrls[webGMEUrl]();
                    delete webGMEUrls[webGMEUrl];
                }
            });
        }

        var workingDirectoryCount = 0;
        var rimraf = nodeRequire('rimraf');
        rimraf(workingDirectory, function (err) {
            if (err) {
                log('Could not delete working directory (' + workingDirectory + '), err: ' + err);
                process.exit(2);
            }
            if (!fs.existsSync(workingDirectory)) {
                fs.mkdirSync(workingDirectory);
            }

            readConfig();
            fs.watch(configFileName, function () {
                setTimeout(readConfig, 200);
            }); // setTimeout: likely handle O_TRUNC of config.json
            // (though `move config.json.tmp config.json` is preferred)
        });
    });

}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="Bin_Apply.html">Bin:Apply</a></li><li><a href="Bin_Diff.html">Bin:Diff</a></li><li><a href="Bin_Export.html">Bin:Export</a></li><li><a href="Bin_Import.html">Bin:Import</a></li><li><a href="Bin_Merge.html">Bin:Merge</a></li><li><a href="Bin_ReassignRelids.html">Bin:ReassignRelids</a></li><li><a href="Bin_RunPlugin.html">Bin:RunPlugin</a></li><li><a href="Bin_StartServer.html">Bin:StartServer</a></li><li><a href="Bin_UserManager.html">Bin:UserManager</a></li><li><a href="CoreAddOns_ConstraintAddOn.html">CoreAddOns:ConstraintAddOn</a></li><li><a href="CoreAddOns_NotificationAddOn.html">CoreAddOns:NotificationAddOn</a></li><li><a href="CoreAddOns_TestAddOn.html">CoreAddOns:TestAddOn</a></li><li><a href="CorePlugins_AddOnGenerator.html">CorePlugins:AddOnGenerator</a></li><li><a href="CorePlugins_ConfigurationArtifact.html">CorePlugins:ConfigurationArtifact</a></li><li><a href="CorePlugins_ConstraintEvaluator.html">CorePlugins:ConstraintEvaluator</a></li><li><a href="CorePlugins_DecoratorGenerator.html">CorePlugins:DecoratorGenerator</a></li><li><a href="CorePlugins_ExecutorPlugin.html">CorePlugins:ExecutorPlugin</a></li><li><a href="CorePlugins_ImportV1.html">CorePlugins:ImportV1</a></li><li><a href="CorePlugins_LayoutGenerator.html">CorePlugins:LayoutGenerator</a></li><li><a href="CorePlugins_MergeExample.html">CorePlugins:MergeExample</a></li><li><a href="CorePlugins_MetaGMEParadigmImporter.html">CorePlugins:MetaGMEParadigmImporter</a></li><li><a href="CorePlugins_MinimalWorkingExample.html">CorePlugins:MinimalWorkingExample</a></li><li><a href="CorePlugins_PluginGenerator.html">CorePlugins:PluginGenerator</a></li><li><a href="CorePlugins_VisualizerGenerator.html">CorePlugins:VisualizerGenerator</a></li><li><a href="Executor_AddLabelJob.html">Executor:AddLabelJob</a></li><li><a href="Executor_NodeWorker.html">Executor:NodeWorker</a></li><li><a href="module-Core.html">Core</a></li><li><a href="module-EnsureDir.html">EnsureDir</a></li><li><a href="module-Storage.html">Storage</a></li><li><a href="Server.module_ConnectedWorker.html">ConnectedWorker</a></li><li><a href="Server.module_SimpleWorker.html">SimpleWorker</a></li><li><a href="Server_API.html">Server:API</a></li><li><a href="Server_GMEAuth.html">Server:GMEAuth</a></li><li><a href="Server_Logger.html">Server:Logger</a></li><li><a href="Server_SafeStorage.html">Server:SafeStorage</a></li><li><a href="Server_ServerWorkerManager.html">Server:ServerWorkerManager</a></li><li><a href="Server_StandAlone.html">Server:StandAlone</a></li><li><a href="Server_Storage.html">Server:Storage</a></li><li><a href="Server_Storage_Dynamo.html">Server:Storage:Dynamo</a></li><li><a href="Server_Storage_Memory.html">Server:Storage:Memory</a></li><li><a href="Server_Storage_Mongo.html">Server:Storage:Mongo</a></li><li><a href="Server_Storage_Neo4j.html">Server:Storage:Neo4j</a></li><li><a href="Server_Storage_Redis.html">Server:Storage:Redis</a></li><li><a href="Server_UserProject.html">Server:UserProject</a></li><li><a href="Server_WebSockets.html">Server:WebSockets</a></li><li><a href="Server_WorkerConstants.html">Server:WorkerConstants</a></li></ul><h3>Externals</h3><ul><li><a href="external-Promise.html">Promise</a></li></ul><h3>Classes</h3><ul><li><a href="AddOnBase.html">AddOnBase</a></li><li><a href="AddOnUpdateResult.html">AddOnUpdateResult</a></li><li><a href="Artifact.html">Artifact</a></li><li><a href="AuthorizerBase.html">AuthorizerBase</a></li><li><a href="BlobClient.html">BlobClient</a></li><li><a href="BlobMetadata.html">BlobMetadata</a></li><li><a href="BlobRunPluginClient.html">BlobRunPluginClient</a></li><li><a href="Core.html">Core</a></li><li><a href="ExecutorClient.html">ExecutorClient</a></li><li><a href="JobInfo.html">JobInfo</a></li><li><a href="OutputInfo.html">OutputInfo</a></li><li><a href="PluginBase.html">PluginBase</a></li><li><a href="PluginConfig.html">PluginConfig</a></li><li><a href="PluginHandler.html">PluginHandler</a></li><li><a href="PluginMessage.html">PluginMessage</a></li><li><a href="PluginNodeDescription.html">PluginNodeDescription</a></li><li><a href="PluginResult.html">PluginResult</a></li><li><a href="Project.html">Project</a></li><li><a href="ProjectInterface.html">ProjectInterface</a></li><li><a href="Server_GMEAuth-GMEAuth.html">GMEAuth</a></li><li><a href="Server_SafeStorage-SafeStorage.html">SafeStorage</a></li><li><a href="Server_Storage_Memory-Memory.html">Memory</a></li><li><a href="Server_UserProject-UserProject.html">UserProject</a></li><li><a href="WorkerRequests.html">WorkerRequests</a></li></ul><h3>Global</h3><ul><li><a href="global.html#cleanUp">cleanUp</a></li><li><a href="global.html#getProjectJson">getProjectJson</a></li><li><a href="global.html#getStats">getStats</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#insertProjectJson">insertProjectJson</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#stop">stop</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Nov 28 2016 13:13:32 GMT-0600 (Central Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
